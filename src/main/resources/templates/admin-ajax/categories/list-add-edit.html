<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin-ajax/layout/layout_admin.html}">
<head>
    <title>Category Management</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
    
    <style>
        .category-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .action-buttons {
            gap: 0.5rem;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
        }
        
        .data-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .data-card .card-header {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            border: none;
            padding: 1.5rem;
        }
        
        .btn-custom-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-custom-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
    </style>
</head>
<body layout:fragment="content">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2">
                    <i class="fas fa-tags me-3"></i>Category Management
                </h2>
                <p class="mb-0 opacity-75">Manage your product categories efficiently</p>
            </div>
            <div>
                <button id="btnAddCategory" class="btn btn-light btn-lg">
                    <i class="fas fa-plus me-2"></i>Add New Category
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="message-alert" class="alert alert-success alert-dismissible fade" role="alert" style="display: none;">
        <i class="fas fa-check-circle me-2"></i>
        <span id="alert-message"></span>
        <button type="button" class="btn-close" aria-label="Close"></button>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="stat-icon" style="background-color: #3498db;">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="ms-3">
                        <div class="text-muted small">Total Categories</div>
                        <div class="h4 mb-0" id="totalCategoriesCount">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="stat-icon" style="background-color: #27ae60;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="ms-3">
                        <div class="text-muted small">Active Categories</div>
                        <div class="h4 mb-0" id="activeCategoriesCount">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="stat-icon" style="background-color: #f39c12;">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="ms-3">
                        <div class="text-muted small">Products</div>
                        <div class="h4 mb-0">156</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="d-flex align-items-center">
                    <div class="stat-icon" style="background-color: #e74c3c;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="ms-3">
                        <div class="text-muted small">Growth</div>
                        <div class="h4 mb-0">+12%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Data Table -->
    <div class="data-card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Categories List
                    </h5>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-light btn-sm" onclick="refreshTable()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="filterTable('all')">All Categories</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterTable('active')">Active Only</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterTable('inactive')">Inactive Only</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="categoryTable" class="table table-hover mb-0">
                    <thead style="background-color: #f8f9fa;">
                        <tr>
                            <th class="px-4 py-3">#</th>
                            <th class="px-4 py-3">Image</th>
                            <th class="px-4 py-3">Category Name</th>
                            <th class="px-4 py-3">Status</th>
                            <th class="px-4 py-3">Created Date</th>
                            <th class="px-4 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-tag me-2"></i>
                        <span id="modalTitle">Add New Category</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="categoryForm" enctype="multipart/form-data">
                    <div class="modal-body p-4">
                        <input type="hidden" id="categoryId" name="categoryId">
                        
                        <div class="row g-4">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-text-width me-1"></i>Category Name *
                                    </label>
                                    <input type="text" class="form-control form-control-lg" 
                                           id="categoryName" name="name" 
                                           placeholder="Enter category name" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-image me-1"></i>Category Image
                                    </label>
                                    <input type="file" class="form-control" 
                                           id="categoryImage" name="images" 
                                           accept="image/*" onchange="previewImage(this)">
                                    <div class="form-text">Upload an image for this category (JPG, PNG, GIF)</div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="mb-2 fw-semibold">Image Preview</div>
                                    <div id="imagePreview" class="border rounded p-3" 
                                         style="min-height: 150px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-custom-primary">
                            <i class="fas fa-save me-1"></i>Save Category
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0">
                <div class="modal-header" style="background-color: #e74c3c; color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-trash me-2"></i>Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div class="mb-4">
                        <i class="fas fa-exclamation-triangle fa-4x text-warning"></i>
                    </div>
                    <h6 class="mb-3">Are you sure you want to delete this category?</h6>
                    <p class="text-muted">This action cannot be undone.</p>
                    <input type="hidden" id="deleteCategoryId">
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Custom JavaScript -->
    <script>
        let categoryTable;
        let isEditMode = false;

        $(document).ready(function() {
            initializeTable();
            loadCategories();
            bindEvents();
        });

        function initializeTable() {
            categoryTable = $('#categoryTable').DataTable({
                responsive: true,
                pageLength: 10,
                lengthChange: false,
                searching: true,
                ordering: true,
                info: true,
                autoWidth: false,
                language: {
                    search: "Search categories:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ categories",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    },
                    emptyTable: "No categories found"
                },
                columnDefs: [
                    { orderable: false, targets: [1, 5] },
                    { searchable: false, targets: [0, 1, 5] },
                    { className: "text-center", targets: [0, 5] },
                    { width: "5%", targets: 0 },
                    { width: "10%", targets: 1 },
                    { width: "25%", targets: 2 },
                    { width: "15%", targets: 3 },
                    { width: "20%", targets: 4 },
                    { width: "25%", targets: 5 }
                ]
            });
        }

        function bindEvents() {
            // Add Category Button
            $('#btnAddCategory').click(function() {
                openAddModal();
            });

            // Form Submit
            $('#categoryForm').submit(function(e) {
                e.preventDefault();
                saveCategory();
            });

            // Modal hidden event
            $('#categoryModal').on('hidden.bs.modal', function() {
                resetForm();
            });
        }

        function loadCategories() {
            $.ajax({
                url: '/api/admin/categories',
                method: 'GET',
                success: function(data) {
                    displayCategories(data);
                    updateStatistics(data);
                },
                error: function(xhr, status, error) {
                    showAlert('Error loading categories: ' + error, 'danger');
                    console.error('Error:', error);
                }
            });
        }

        function displayCategories(categories) {
            categoryTable.clear();
            
            categories.forEach((category, index) => {
                const imageHtml = category.images ? 
                    `<img src="/images/category/${category.images}" class="category-image" alt="${category.name}">` :
                    '<div class="category-image d-flex align-items-center justify-content-center bg-light"><i class="fas fa-image text-muted"></i></div>';
                
                const statusBadge = `<span class="badge bg-success status-badge">Active</span>`;
                
                const createdDate = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const actionsHtml = `
                    <div class="action-buttons d-flex justify-content-center">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory(${category.categoryId})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${category.categoryId})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info ms-1" onclick="viewCategoryDetails(${category.categoryId})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                `;

                categoryTable.row.add([
                    index + 1,
                    imageHtml,
                    `<div class="fw-semibold">${category.name}</div>`,
                    statusBadge,
                    createdDate,
                    actionsHtml
                ]);
            });
            
            categoryTable.draw();
        }

        function updateStatistics(categories) {
            $('#totalCategoriesCount').text(categories.length);
            $('#activeCategoriesCount').text(categories.length);
        }

        function openAddModal() {
            isEditMode = false;
            $('#modalTitle').text('Add New Category');
            $('#categoryModal').modal('show');
        }

        function editCategory(id) {
            isEditMode = true;
            $('#modalTitle').text('Edit Category');
            
            $.ajax({
                url: `/api/admin/categories/${id}`,
                method: 'GET',
                success: function(category) {
                    $('#categoryId').val(category.categoryId);
                    $('#categoryName').val(category.name);
                    
                    if (category.images) {
                        $('#imagePreview').html(`<img src="/images/category/${category.images}" class="img-fluid rounded" style="max-height: 150px;">`);
                    }
                    
                    $('#categoryModal').modal('show');
                },
                error: function(xhr, status, error) {
                    showAlert('Error loading category: ' + error, 'danger');
                }
            });
        }

        function deleteCategory(id) {
            $('#deleteCategoryId').val(id);
            $('#deleteModal').modal('show');
        }

        function confirmDelete() {
            const id = $('#deleteCategoryId').val();
            
            $.ajax({
                url: `/api/admin/categories/${id}`,
                method: 'DELETE',
                success: function() {
                    $('#deleteModal').modal('hide');
                    showAlert('Category deleted successfully!', 'success');
                    loadCategories();
                },
                error: function(xhr, status, error) {
                    showAlert('Error deleting category: ' + error, 'danger');
                }
            });
        }

        function saveCategory() {
            const formData = new FormData();
            const name = $('#categoryName').val();
            const file = $('#categoryImage')[0].files[0];
            
            if (!name.trim()) {
                showAlert('Category name is required!', 'warning');
                return;
            }
            
            formData.append('name', name);
            if (file) {
                formData.append('images', file);
            }
            
            const url = isEditMode ? `/api/admin/categories/${$('#categoryId').val()}` : '/api/admin/categories';
            const method = isEditMode ? 'PUT' : 'POST';
            
            $.ajax({
                url: url,
                method: method,
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#categoryModal').modal('hide');
                    const message = isEditMode ? 'Category updated successfully!' : 'Category added successfully!';
                    showAlert(message, 'success');
                    loadCategories();
                },
                error: function(xhr, status, error) {
                    const message = isEditMode ? 'Error updating category: ' : 'Error adding category: ';
                    showAlert(message + error, 'danger');
                }
            });
        }

        function resetForm() {
            $('#categoryForm')[0].reset();
            $('#categoryId').val('');
            $('#imagePreview').html('<i class="fas fa-image fa-3x text-muted"></i>');
            isEditMode = false;
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#imagePreview').html(`<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 150px;">`);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showAlert(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'danger' ? 'alert-danger' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const iconClass = type === 'success' ? 'fa-check-circle' :
                             type === 'danger' ? 'fa-exclamation-circle' :
                             type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            $('#message-alert')
                .removeClass('alert-success alert-danger alert-warning alert-info')
                .addClass(alertClass)
                .html(`<i class="fas ${iconClass} me-2"></i>${message}`)
                .fadeIn()
                .delay(3000)
                .fadeOut();
        }

        function refreshTable() {
            loadCategories();
            showAlert('Table refreshed!', 'info');
        }

        function filterTable(type) {
            // Placeholder for filter functionality
            showAlert(`Filter applied: ${type}`, 'info');
        }

        function viewCategoryDetails(id) {
            // Placeholder for view details functionality
            showAlert('View details feature - Coming soon!', 'info');
        }
    </script>
</body>
</html>